<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AnÃ¡lise de Dados do Solo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .card-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }

        .card-unit {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .chart-container h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #3498db;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #7f8c8d;
        }

        .btn-secondary:hover {
            background: #636e72;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219653;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online {
            background: #27ae60;
        }

        .status-offline {
            background: #e74c3c;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 1rem;
            color: #7f8c8d;
            border-top: 1px solid #ddd;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .error {
            background: #ffeaa7;
            color: #d35400;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .nav-btn {
            background: #ecf0f1;
            color: #2c3e50;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .nav-btn:hover {
            background: #bdc3c7;
        }

        .nav-btn.active {
            background: #3498db;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸŒ± Dashboard IoT - AnÃ¡lise de Dados do Solo</h1>
            <p>Sistema de monitoramento em tempo real para agricultura de precisÃ£o</p>
            <div class="navigation">
                <a href="/" class="nav-btn active">Dashboard</a>
                <a href="/analise" class="nav-btn">AnÃ¡lise EstatÃ­stica</a>
            </div>
        </header>

        <!-- Cards de Status -->
        <div class="cards">
            <div class="card">
                <h3>Temperatura do Solo</h3>
                <div class="card-value" id="temp-solo">--</div>
                <div class="card-unit">Â°C</div>
            </div>
            <div class="card">
                <h3>Umidade do Solo</h3>
                <div class="card-value" id="umidade-solo">--</div>
                <div class="card-unit">%</div>
            </div>
            <div class="card">
                <h3>pH do Solo</h3>
                <div class="card-value" id="ph-solo">--</div>
                <div class="card-unit">pH</div>
            </div>
            <div class="card">
                <h3>Dias Monitorados</h3>
                <div class="card-value" id="dias-monitorados">--</div>
                <div class="card-unit">dias</div>
            </div>
        </div>

        <!-- Controles -->
        <div class="controls">
            <h2>Controles</h2>
            <button class="btn" onclick="carregarDados()">
                ðŸ”„ Atualizar Dados
            </button>
            <button class="btn btn-secondary" onclick="exportarDados('csv')">
                ðŸ“¥ Exportar CSV
            </button>
            <button class="btn btn-secondary" onclick="exportarDados('json')">
                ðŸ“¥ Exportar JSON
            </button>
            <button class="btn btn-success" onclick="window.open('/analise', '_blank')">
                ðŸ“Š AnÃ¡lise Completa
            </button>
            <div style="margin-top: 10px;">
                <span class="status-indicator status-online"></span>
                <span id="status-api">Conectado Ã  API</span>
            </div>
        </div>

        <!-- GrÃ¡ficos -->
        <div class="chart-row">
            <div class="chart-container">
                <h2>Temperatura e Umidade do Solo</h2>
                <canvas id="chartTemperaturaUmidade"></canvas>
            </div>
            <div class="chart-container">
                <h2>NÃ­vel de pH</h2>
                <canvas id="chartPH"></canvas>
            </div>
        </div>

        <div class="chart-row">
            <div class="chart-container">
                <h2>CondiÃ§Ãµes AtmosfÃ©ricas</h2>
                <canvas id="chartAtmosfera"></canvas>
            </div>
            <div class="chart-container">
                <h2>ProduÃ§Ã£o (kg)</h2>
                <canvas id="chartProducao"></canvas>
            </div>
        </div>

        <!-- Ãšltimos Registros -->
        <div class="chart-container">
            <h2>Ãšltimos Registros</h2>
            <div id="ultimos-registros" class="loading">
                Carregando dados...
            </div>
        </div>

        <footer>
            <p>IoT Agro Analytics â€¢ Sistema de Monitoramento do Solo</p>
            <p>VersÃ£o 1.0.0 â€¢ Dados atualizados em tempo real</p>
        </footer>
    </div>

    <script>
        // VariÃ¡veis globais
        let charts = {};
        let dadosAtuais = [];

        // InicializaÃ§Ã£o
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            setInterval(carregarDados, 30000); // Atualizar a cada 30 segundos
        });

        // FunÃ§Ã£o para carregar dados do dashboard
        async function carregarDados() {
            try {
                document.getElementById('status-api').textContent = 'Carregando dados...';
                
                const response = await axios.get('/dashboard/dados');
                
                if (response.data.status === 'ok') {
                    document.getElementById('status-api').textContent = 'Dados atualizados: ' + new Date().toLocaleTimeString();
                    dadosAtuais = response.data.dados;
                    atualizarCards(response.data.estatisticas);
                    atualizarGraficos(dadosAtuais);
                    atualizarUltimosRegistros(dadosAtuais);
                } else {
                    throw new Error(response.data.mensagem);
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                document.getElementById('status-api').textContent = 'Erro ao conectar: ' + error.message;
                mostrarErro('NÃ£o foi possÃ­vel carregar os dados. Verifique a conexÃ£o com a API.');
            }
        }

        // Atualizar cards com estatÃ­sticas
        function atualizarCards(estatisticas) {
            if (estatisticas.temp_solo) {
                document.getElementById('temp-solo').textContent = estatisticas.temp_solo.toFixed(1);
            }
            if (estatisticas.umidade_solo) {
                document.getElementById('umidade-solo').textContent = estatisticas.umidade_solo.toFixed(1);
            }
            if (estatisticas.temp_ar) {
                // Usando temp_ar como placeholder para pH
                document.getElementById('ph-solo').textContent = '6.5'; // Valor exemplo
            }
            if (estatisticas.dias_monitorados) {
                document.getElementById('dias-monitorados').textContent = estatisticas.dias_monitorados;
            }
        }

        // Atualizar grÃ¡ficos
        function atualizarGraficos(dados) {
            // Preparar labels (datas)
            const labels = dados.map(d => {
                const date = new Date(d.data_observacao);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }).reverse();

            // Dados para os grÃ¡ficos
            const temperaturas = dados.map(d => d.temperatura_solo).reverse();
            const umidades = dados.map(d => d.umidade_solo).reverse();
            const phs = dados.map(d => d.ph).reverse();
            const temperaturasAr = dados.map(d => d.temperatura_ar).reverse();
            const umidadesAr = dados.map(d => d.umidade_relativa).reverse();
            const producoes = dados.map(d => d.producao_kg).reverse();

            // GrÃ¡fico 1: Temperatura e Umidade do Solo
            const ctx1 = document.getElementById('chartTemperaturaUmidade').getContext('2d');
            if (charts.chart1) charts.chart1.destroy();
            charts.chart1 = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temperatura Solo (Â°C)',
                            data: temperaturas,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Umidade Solo (%)',
                            data: umidades,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });

            // GrÃ¡fico 2: pH
            const ctx2 = document.getElementById('chartPH').getContext('2d');
            if (charts.chart2) charts.chart2.destroy();
            charts.chart2 = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'pH do Solo',
                        data: phs,
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 4,
                            max: 9
                        }
                    }
                }
            });

            // GrÃ¡fico 3: Atmosfera
            const ctx3 = document.getElementById('chartAtmosfera').getContext('2d');
            if (charts.chart3) charts.chart3.destroy();
            charts.chart3 = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temp. Ar (Â°C)',
                            data: temperaturasAr,
                            borderColor: '#e67e22',
                            backgroundColor: 'rgba(230, 126, 34, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Umidade Ar (%)',
                            data: umidadesAr,
                            borderColor: '#1abc9c',
                            backgroundColor: 'rgba(26, 188, 156, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });

            // GrÃ¡fico 4: ProduÃ§Ã£o
            const ctx4 = document.getElementById('chartProducao').getContext('2d');
            if (charts.chart4) charts.chart4.destroy();
            charts.chart4 = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ProduÃ§Ã£o (kg)',
                        data: producoes,
                        backgroundColor: 'rgba(46, 204, 113, 0.6)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Atualizar tabela de Ãºltimos registros
        function atualizarUltimosRegistros(dados) {
            const container = document.getElementById('ultimos-registros');
            const ultimos10 = dados.slice(0, 10);
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #3498db;">Data/Hora</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #3498db;">Temp. Solo</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #3498db;">Umidade</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #3498db;">pH</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #3498db;">ProduÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            ultimos10.forEach(registro => {
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px;">${registro.data_observacao}</td>
                        <td style="padding: 10px;">${registro.temperatura_solo ? registro.temperatura_solo.toFixed(1) + 'Â°C' : '--'}</td>
                        <td style="padding: 10px;">${registro.umidade_solo ? registro.umidade_solo.toFixed(1) + '%' : '--'}</td>
                        <td style="padding: 10px;">${registro.ph ? registro.ph.toFixed(2) : '--'}</td>
                        <td style="padding: 10px;">${registro.producao_kg ? registro.producao_kg.toFixed(2) + ' kg' : '--'}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // Exportar dados
        function exportarDados(formato) {
            window.open(`/api/exportar?formato=${formato}`, '_blank');
        }

        // Mostrar erro
        function mostrarErro(mensagem) {
            const container = document.querySelector('.container');
            const erroDiv = document.createElement('div');
            erroDiv.className = 'error';
            erroDiv.textContent = mensagem;
            
            // Insere apÃ³s o header
            const header = document.querySelector('header');
            container.insertBefore(erroDiv, header.nextSibling);
            
            // Remove apÃ³s 5 segundos
            setTimeout(() => {
                erroDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>